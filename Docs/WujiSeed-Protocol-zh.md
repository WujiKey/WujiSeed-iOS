# WujiSeed 协议规范

**协议版本:** `WUJI-Key-V1`
**文档版本:** 1.0
**日期:** 2026-01

---

## 摘要

WujiSeed是一个创新的加密货币助记词生成与备份协议，核心理念是：

> **用记得住的，生成记不住的。**

用户只需记住：
- 一个**个人标识**（如姓名、邮箱）
- **5个有意义的地点**及其相关记忆画面关键词

协议通过BLAKE2b、Argon2id等密码学原语将这些输入确定性地转换为标准BIP39助记词，提供银行级安全性，在有加密备份的情况下支持遗忘恢复（仅需3个地点即可恢复）。

---

## 1. 生成流程

```
┌─────────────────────────────────────────────────────────────────┐
│                     用户输入                                     │
├─────────────────────────────────────────────────────────────────┤
│  个人标识（姓名/邮箱）                                           │
│  ├── 文本标准化 ──→ Normalize(identifier)                      │
│  └── 盐值派生 ──→ BLAKE2b-128 ──→ salt (16字节)                │
│                                                                  │
│  5个地点 × (坐标 + 两个记忆画面关键词)                                     │
│  ├── 坐标 ──→ F9Grid单元格索引 + 方位码                         │
│  ├── 关键词 ──→ 标准化 + 排序                                  │
│  └── 合并编码 ──→ keyMaterial (按字节序排列)                     │
├─────────────────────────────────────────────────────────────────┤
│                     密钥派生                                     │
├─────────────────────────────────────────────────────────────────┤
│  Argon2id(                                                       │
│    entropy = keyMaterial[0] ‖ keyMaterial[1] ‖ ... ‖ [4],      │
│    salt = 16字节盐值,                                            │
│    memory = 256 MB,                                              │
│    iterations = 7                                                │
│  ) ──→ 256位熵值                                                 │
├─────────────────────────────────────────────────────────────────┤
│                     BIP39编码                                   │
├─────────────────────────────────────────────────────────────────┤
│  256位熵值 ──→ 23个单词 (253位)                                  │
│  剩余3位 + SHA256校验和(8位) ──→ 第24个单词                      │
│                                                                  │
│  输出: 24个BIP39助记词                                         │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 数据结构

### 2.1 地点记录 (Spot)

```
Spot = {
  place:       WujiPlace,    // 地理坐标
  memory1Tags: [String],   // 第一组记忆画面关键词标签（1-3个，推荐1个高度个性化关键词）
  memory2Tags: [String]    // 第二组记忆画面关键词标签（1-3个，推荐1个高度个性化关键词）
}
```

### 2.2 地点编码

```
keyMaterial = processedMemory(UTF-8) + cellIndex(8字节大端序)
```

**编码规则：**
- `processedMemory`：所有标签标准化后合并、去重、按Unicode排序、无分隔符拼接
- `cellIndex`：F9Grid单元格索引，8字节大端序（详见附录 C）

---

## 3. 加密备份 (记忆遗忘容错机制)

### 3.1 设计原理

为实现"仅需 3 个地点即可恢复"，协议生成 C(5,3)=10 个独立加密块。每个块使用不同的 3 地点组合派生的密钥加密。加密后组合顺序随机打乱，无法从索引推断原始组合。

### 3.2 加密算法

```
┌────────────────────────────────────────────────────────────────────────┐
│  Encrypt(words[24], keyMaterials[5], positionCodes[5], salt)          │
├────────────────────────────────────────────────────────────────────────┤
│  1. mnemonicData ← WordsToBytes(words)          // 33 字节            │
│  2. sortedKM ← sort(keyMaterials)               // 按字节序排序       │
│  3. AAD ← BuildAAD(positionCodes)               // 9 字节             │
│                                                                        │
│  4. 对于每个组合 {a, b, c} ∈ C(5,3):                                  │
│       password ← sortedKM[a] ‖ sortedKM[b] ‖ sortedKM[c]             │
│       key ← Argon2id(password, salt)            // 32 字节            │
│       padding ← RandomBytes(16)                                        │
│       plaintext ← mnemonicData ‖ padding        // 49 字节            │
│       (ciphertext, tag, nonce) ← XChaCha20Poly1305.Encrypt(           │
│                                    plaintext, key, AAD)               │
│       blocks[j] ← {nonce, ciphertext, tag}                            │
│                                                                        │
│  5. shuffledBlocks ← DeterministicShuffle(blocks, sortedKM)           │
│  6. return Serialize(positionCodes, shuffledBlocks)                    │
└────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 恢复算法

### 4.1 方法一：加密备份恢复

**适用场景：** 用户有加密备份文件，但只记得 3-5 个地点

**恢复流程：**
1. 枚举 N 个已知地点选 3 个的所有组合
2. 枚举 5 个方位码选 3 个的所有组合（10种）
3. 对每个组合，使用 Argon2id 派生密钥并尝试解密 10 个加密块
4. 通过多次尝试，解密成功且校验和通过时，返回助记词

### 4.2 方法二：完全记忆恢复

**适用场景：** 用户没有备份文件，但完整记得所有5个地点及记忆关键词+5个方位码
用同样的生成逻辑来恢复助记词，这过程中需要用5个方位码进行纠偏找回原始网格ID

---

## 附录 A: 盐值派生

从个人标识生成盐值（16字节）：

```
salt = BLAKE2b-128(UTF8(Normalize(identifier)) + UTF8("WUJI-Key-V1:Memory-Based Seed Phrases"))
```

- 输出：16 字节（128 位）
- 版本后缀确保协议升级时盐值会改变

---

## 附录 B: 文本标准化

### B.1 标准化流程

所有用户输入文本必须经过标准化处理，确保不同输入方式产生一致结果：

```
Normalize(s) = AsciiPunctNorm(CollapseWS(Trim(CaseFold(NFKC(s)))))
```

**处理步骤：**

| 步骤 | 函数 | 说明 | 示例 |
|------|------|------|------|
| 1 | NFKC | Unicode 兼容性标准化 | `Ｈｅｌｌｏ` → `Hello` |
| 2 | CaseFold | 大小写折叠 | `Hello` → `hello` |
| 3 | Trim | 移除首尾空白 | `  hello  ` → `hello` |
| 4 | CollapseWS | 折叠连续空白为单个空格 | `hello   world` → `hello world` |
| 5 | AsciiPunctNorm | 中日韩标点转 ASCII | `，。！` → `,.!` |

### B.2 标点映射表

```
中文/全角标点 ──→ ASCII 标点
  ，  ──→  ,    （逗号）
  。  ──→  .    （句号）
  ！  ──→  !    （感叹号）
  ？  ──→  ?    （问号）
  ：  ──→  :    （冒号）
  ；  ──→  ;    （分号）
  （）──→  ()   （括号）
  【】──→  []   （方括号）
  「」──→  ''   （引号）
  『』──→  ""   （双引号）
  ——  ──→  -    （破折号）
  …   ──→  ...  （省略号）
```

---

## 附录 C: F9Grid 地理编码

### C.1 单元格索引 (CellIndex)

**用途：** 将地理坐标转换为层次化单元格唯一标识符

```
cellIndex = F9Grid.CellIndex(lat, lng)  // Int64
```

**编码规则：**
- 输入：经纬度坐标 (lat, lng)
- 输出：Int64 类型的单元格索引
- 编码方式：8 字节大端序 (Big-Endian)

**示例：**
```
输入: ["七十二变", "筋斗云"], ["孙悟空"]
处理: 标准化 → 合并 → 去重 → 排序 → "七十二变孙悟空筋斗云"
编码: UTF8("七十二变孙悟空筋斗云") + BE64(cellIndex)
```

### C.2 方位码 (Position Code)

**用途：** 修正GPS漂移，标识坐标在单元格内的位置

F9Grid 将每个单元格划分为 9 个子区域，编码为 1-9：

```
+---+---+---+
| 4 | 9 | 2 |   NW  N  NE
+---+---+---+
| 3 | 5 | 7 |   W   C  E
+---+---+---+
| 8 | 1 | 6 |   SW  S  SE
+---+---+---+
```

**工作原理：**
- GPS 漂移可能导致坐标落入相邻单元格
- 方位码记录原始坐标在单元格内的位置
- 恢复时使用方位码找回原始单元格索引

**接口：**

| 函数 | 输入 | 输出 | 说明 |
|------|------|------|------|
| `CellIndex` | (lat, lng) | Int64 | 层次化单元格唯一标识符 |
| `PositionCode` | (lat, lng) | 1-9 | 单元格内 9 宫格位置 |
| `FindOriginalCell` | (lat, lng, code) | Int64 | 使用方位码纠正 GPS 漂移 |

---

## 参考资料

- [BIP39: 生成确定性密钥的助记词规范](https://github.com/bitcoin/bips/blob/master/bip-0039.mediawiki)
- [Argon2: 密码哈希函数](https://datatracker.ietf.org/doc/html/rfc9106)
- [BLAKE2: 安全哈希函数](https://www.blake2.net/)
- [XChaCha20-Poly1305](https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-xchacha)
