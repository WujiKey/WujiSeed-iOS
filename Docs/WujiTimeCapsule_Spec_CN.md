# WujiTimeCapsule 规范

**版本:** 1.0
**状态:** 草案
**更新日期:** 2025-12

## 概述

WujiTimeCapsule 是一种加密二进制格式，专为 24 个 BIP39 助记词的安全备份和跨设备传输而设计。它采用 XChaCha20-Poly1305 AEAD 加密，并通过地理位置数据进行冗余密钥派生，仅需 5 个位置中的任意 3 个即可恢复助记词。

## 设计目标

1. **安全性**: 军用级加密 (XChaCha20-Poly1305)，256 位密钥
2. **冗余性**: C(5,3)=10 个加密块，任意 3 个位置即可恢复
3. **可移植性**: 自包含的二进制格式，支持跨设备传输
4. **完整性**: CRC32 校验和，检测数据损坏
5. **简洁性**: 最小化格式，无外部依赖

## 二进制格式

### 结构概览

```
┌─────────────────────────────────────────────────────────┐
│ 头部 (Header)                                           │
├─────────────────────────────────────────────────────────┤
│   魔数 (4 字节)              57 55 4A 49                │
│   版本 (1 字节)              01                         │
│   选项 (1 字节)              00 (保留)                  │
│   载荷长度 (2 字节)          大端序                      │
├─────────────────────────────────────────────────────────┤
│ 载荷 (Payload)                                          │
├─────────────────────────────────────────────────────────┤
│   方位码 (3 字节)            5 个码压缩存储              │
│   AEAD 区段                                             │
│     块数量 (1 字节)          10 (C(5,3) 组合)           │
│     加密块 × 10                                         │
│       块长度 (2 字节)                                   │
│       随机数 (24 字节)                                  │
│       密文 (可变长度)                                   │
│       认证标签 (16 字节)                                │
├─────────────────────────────────────────────────────────┤
│ 校验和                                                  │
├─────────────────────────────────────────────────────────┤
│   CRC32 (4 字节)             大端序                     │
└─────────────────────────────────────────────────────────┘
```

### 字段定义

#### 魔数 (4 字节)
```
偏移量: 0x00
值:     57 55 4A 49
```
- `57 55 4A 49`: ASCII 码 "WUJI"

#### 版本 (1 字节)
```
偏移量: 0x04
值:     0x01
```
当前版本为 `0x01`。未来版本可能引入新字段或算法。

#### 选项 (1 字节)
```
偏移量: 0x05
值:     0x00
```
保留供未来使用，当前必须为 `0x00`。

#### 载荷长度 (2 字节)
```
偏移量: 0x06
格式:   大端序无符号 16 位整数
```
此字段之后所有内容的长度（包括 CRC32 校验和）。

#### 方位码 (3 字节)
```
偏移量: 0x08
格式:   压缩半字节
```
5 个方位码 (1-9) 压缩存储于 3 字节中：

| 字节 | 高 4 位 | 低 4 位 |
|------|---------|---------|
| 0    | 码 1    | 码 2    |
| 1    | 码 3    | 码 4    |
| 2    | 码 5    | (未用)  |

方位码代表九宫格位置：
```
4(西北)  9(北)   2(东北)
3(西)    5(中)   7(东)
8(西南)  1(南)   6(东南)
```

#### 块数量 (1 字节)
```
偏移量: 0x0B
值:     0x0A (10)
```
加密块数量，恒为 10（C(5,3) 组合数）。

#### 加密块 (重复)

每个块包含：

| 字段 | 大小 | 说明 |
|------|------|------|
| 块长度 | 2 字节 | 总长度 (随机数 + 密文 + 标签)，大端序 |
| 随机数 | 24 字节 | XChaCha20 随机 nonce |
| 密文 | 可变 | 加密后的助记词 |
| 标签 | 16 字节 | Poly1305 认证标签 |

#### CRC32 校验和 (4 字节)
```
偏移量: 末尾 - 4
格式:   大端序无符号 32 位整数
```
对前面所有字节（从魔数到最后一个加密块）计算的 CRC32 校验和。

多项式: `0xEDB88320` (IEEE 802.3)

## 加密方案

### 算法
- **加密算法**: XChaCha20-Poly1305 AEAD
- **密钥长度**: 256 位 (32 字节)
- **随机数长度**: 192 位 (24 字节)
- **标签长度**: 128 位 (16 字节)

### 密钥派生

对于 10 种组合中的每一种（从 5 个位置中选 3 个）：

```
input = keyMaterial1 + "|" + keyMaterial2 + "|" + keyMaterial3 + "|" + "WujiTimeCapsule-V1"
key = BLAKE2b-256(input)
```

其中 `keyMaterial` 是外部预处理的数据（通常为：标准化备注 + F9Grid 格子 ID）。

### 关联数据 (AAD)

AEAD 认证覆盖：
```
AAD = 魔数 (4) + 版本 (1) + 选项 (1) + 方位码 (3)
```
共 9 字节

### 明文格式

24 个助记词用单个空格连接：
```
word1 word2 word3 ... word24
```
使用 UTF-8 编码。

## 操作流程

### 加密流程

1. 验证输入：
   - 24 个助记词
   - 5 个位置输入，含方位码 (1-9)

2. 生成 10 个加密块：
   - 对每个 3 位置组合
   - 使用 BLAKE2b-256 派生密钥
   - 生成随机 24 字节 nonce
   - 使用 XChaCha20-Poly1305 加密

3. 序列化为二进制：
   - 写入头部（魔数、版本、选项）
   - 计算并写入载荷长度
   - 写入方位码
   - 写入块数量和所有加密块
   - 计算并追加 CRC32

### 解密流程

1. 解析并验证二进制数据：
   - 验证魔数
   - 校验 CRC32 完整性

2. 验证方位码与输入位置匹配

3. 尝试解密：
   - 对每个加密块（对应一个 3 位置组合）
   - 使用相同的 3 个位置派生密钥
   - 尝试 AEAD 解密
   - 若成功，返回 24 个助记词

4. 任一块解密成功即可

## 安全考量

### 优势
- XChaCha20-Poly1305 提供 IND-CCA2 安全性
- 192 位随机数消除 nonce 重用风险
- BLAKE2b 密钥派生抵抗长度扩展攻击
- 冗余加密允许部分位置恢复

### 建议
- WUJI加密备份文件与位置提示分开存储
- 使用高熵、易记忆的位置备注
- 解密后验证助记词正确性（BIP39 校验）
- 操作完成后安全删除临时文件

### 威胁模型
- **已防护**: 静态数据、传输拦截
- **未防护**: 掌握位置信息的主动攻击者、侧信道攻击

## 实现说明

### 最小文件大小

24 个 BIP39 单词（平均约 80 字符）：
```
头部:           8 字节
方位码:         3 字节
块数量:         1 字节
每块:           2 + 24 + ~80 + 16 = ~122 字节
10 块:          ~1220 字节
CRC32:          4 字节
─────────────────────────────
总计:           ~1236 字节
```

### 字节序

所有多字节整数使用**大端序**。

### 错误处理

| 错误 | 原因 |
|------|------|
| 无效魔数 | 非WUJI加密备份文件 |
| CRC32 不匹配 | 数据损坏 |
| 方位码不匹配 | 提供的位置错误 |
| 解密失败 | 位置数据不正确 |

## 文件扩展名

推荐: `.wuji`

MIME 类型 (建议): `application/x-wuji`

## 版本历史

| 版本 | 日期 | 变更 |
|------|------|------|
| 0x01 | 2024-12 | 初始规范 |

## 参考资料

- [BIP39: 生成确定性密钥的助记词规范](https://github.com/bitcoin/bips/blob/master/bip-0039.mediawiki)
- [XChaCha20-Poly1305](https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-xchacha)
- [BLAKE2: 快速安全哈希](https://www.blake2.net/)
- [F9Grid 坐标系统](./F9Grid_Spec.md)
